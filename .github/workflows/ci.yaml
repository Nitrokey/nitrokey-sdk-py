name: Continuous integration
on: [push, pull_request]

env:
  REQUIRED_PACKAGES: make

jobs:
  format-code:
    name: Check code format
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Install Poetry
        run: pip install poetry
      - name: Create virtual environment
        run: make install
      - name: Check code format
        run: make check-format
  format-import:
    name: Check imports sorting
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Install Poetry
        run: pip install poetry
      - name: Create virtual environment
        run: make install
      - name: Check code import format
        run: make check-import-sorting
  lint-style:
    name: Check code style
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Install Poetry
        run: pip install poetry
      - name: Create virtual environment
        run: make install
      - name: Check code style
        run: make check-style
  lint-typing:
    name: Check static typing
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Install Poetry
        run: pip install poetry
      - name: Create virtual environment
        run: make install
      - name: Check code static typing
        run: make check-typing
  lint-poetry:
    name: Check poetry configuration
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Install Poetry
        run: pip install poetry
      - name: Create virtual environment
        run: make install
      - name: Check poetry configuration
        run: make check-poetry
  test:
    name: Run test suite
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Install Poetry
        run: pip install poetry
      - name: Create virtual environment
        run: make install
      - name: Run test suite
        run: make test
  test-update:
    name: Run test suite with updated dependencies
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Install Poetry
        run: pip install poetry
      - name: Create virtual environment
        run: make install
      - name: Update locked dependencies
        run: make update
      - name: Run test suite
        run: make test
  test-pip:
    name: Run test suite with pip installation
    runs-on: ubuntu-latest
    container: python:3.9-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install required packages
        run: apt update && apt install -y ${REQUIRED_PACKAGES}
      - name: Create virtual environment
        run: python3 -m venv venv
      - name: Install SDK
        run: ./venv/bin/pip install .
      - name: Run test suite
        run: ./venv/bin/python -m unittest -v
